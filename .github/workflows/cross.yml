name: Cross YTGet

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up latest Python 3
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # -------------------------
    # Download yt-dlp per OS
    # -------------------------
    - name: Download yt-dlp (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe -o yt-dlp.exe

    - name: Download yt-dlp (Linux/macOS)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o yt-dlp
        chmod +x yt-dlp

    # -------------------------
    # Download ffmpeg & ffprobe per OS
    # -------------------------
    - name: Download ffmpeg (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        curl -L https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip -o ffmpeg.zip
        Expand-Archive -Path ffmpeg.zip -DestinationPath .
        $ffmpegPath = Get-ChildItem -Recurse -Filter ffmpeg.exe | Select-Object -First 1
        $ffprobePath = Get-ChildItem -Recurse -Filter ffprobe.exe | Select-Object -First 1
        Copy-Item $ffmpegPath.FullName .
        Copy-Item $ffprobePath.FullName .

    - name: Install ffmpeg (Linux)
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        cp "$(which ffmpeg)" .
        cp "$(which ffprobe)" .

    - name: Install ffmpeg (macOS)
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        brew install ffmpeg
        cp "$(which ffmpeg)" .
        cp "$(which ffprobe)" .

    # -------------------------
    # Build with PyInstaller
    # -------------------------
    - name: Build with PyInstaller
      shell: bash
      run: |
        pyinstaller --noconfirm --onedir --windowed \
          --icon "icon.ico" \
          --name "YTGet" \
          --clean --noupx \
          --version-file "version_info.txt" \
          --hidden-import "PySide6.QtCore" \
          --hidden-import "PySide6.QtGui" \
          --hidden-import "PySide6.QtWidgets" \
          --hidden-import "requests" \
          --hidden-import "mutagen" \
          --hidden-import "PIL" \
          --hidden-import "webbrowser" \
          --hidden-import "mutagen.id3" \
          --hidden-import "mutagen.flac" \
          --add-data "__init__.py:." \
          --add-data "__main__.py:." \
          --add-data "ffmpeg*:. " \
          --add-data "ffprobe*:. " \
          --add-data "icon.ico:." \
          --add-data "LICENSE:." \
          --add-data "main_window.py:." \
          --add-data "README.md:." \
          --add-data "RELEASE_NOTES.md:." \
          --add-data "settings.py:." \
          --add-data "styles.py:." \
          --add-data "yt-dlp*:." \
          --add-data "dialogs:dialogs/" \
          --add-data "utils:utils/" \
          --add-data "widgets:widgets/" \
          --add-data "workers:workers/" \
          "main.py"

    # -------------------------
    # Package build
    # -------------------------
    - name: Zip build
      shell: bash
      run: |
        cd dist
        zip -r ../YTGet-${{ matrix.os }}.zip YTGet

    - name: Generate SHA-256 checksum
      shell: bash
      run: |
        shasum -a 256 YTGet-${{ matrix.os }}.zip > YTGet-${{ matrix.os }}.zip.sha256

    # -------------------------
    # Upload artifacts
    # -------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: YTGet-build-${{ matrix.os }}
        path: |
          dist/YTGet
          YTGet-${{ matrix.os }}.zip
          YTGet-${{ matrix.os }}.zip.sha256
        retention-days: 14